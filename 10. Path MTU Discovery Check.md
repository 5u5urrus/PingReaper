# Path MTU Discovery Check (`icmp_pmtud_check`)

## Opening Scenario

During an external assessment, a tester sends a single oversized packet with “Don’t Fragment” set. The target replies with **ICMP Destination Unreachable, Fragmentation Needed (Type 3, Code 4)** and even includes the **next-hop MTU**. With that one response, the tester learns the maximum packet size that will traverse the path and confirms ICMP is permitted — intelligence that can be used to optimize attacks and detect misconfigurations.

## What This Test Is

Path MTU Discovery (PMTUD) uses ICMP Type 3, Code 4 to signal that a packet is too large to traverse a link without fragmentation when the DF bit is set.
This check sends an oversized, DF-set ICMP Echo Request and observes whether the target (or an intermediate router) returns “Fragmentation Needed,” optionally with the **reported MTU**.

## Why This Matters

* **Network intelligence:** Reveals path MTU and confirms ICMP reachability along the route.
* **Attack optimization:** Allows an attacker to tune payload sizes to avoid fragmentation, IDS evasion issues, or transport failures.
* **Misconfig detection:** Lack of proper PMTUD behavior can indicate **PMTU black holes**, causing timeouts exploitable for DoS or stealth scanning (dropped but not alerted).

## How It Works

1. Send a packet larger than typical MTU (e.g., >1500 bytes) with the **DF** flag set.
2. If a device on the path cannot forward it without fragmentation, it should return **ICMP Type 3, Code 4** and may include the **next-hop MTU value**.
3. The tool records whether a PMTUD response is seen and captures any **reported MTU**.

## Realistic Scenarios

* **VPN Degradation Mapping** – A red team probes a VPN concentrator and receives “Fragmentation Needed” with MTU **1420**, confirming tunnel overhead and that ICMP is allowed through the path. They tune exfiltration and C2 traffic to packet sizes ≤1420 to avoid drops and detection.
* **Black Hole Identification** – An internet-facing service never sends Type 3/Code 4; large DF packets simply vanish. The team flags a **PMTU black hole** caused by overzealous ICMP filtering, explaining sporadic client timeouts and enabling a low-noise DoS by pushing oversized traffic.

## Defensive Recommendations

* Ensure **ICMP Type 3, Code 4** is permitted for valid PMTUD while filtering other risky ICMP types.
* Implement **TCP MSS clamping** on edge devices to mitigate MTU issues when ICMP is filtered upstream.
* Monitor for abnormal volumes of DF-set oversized packets and sudden MTU shifts (possible probing or abuse).
* Document standard MTUs across tunnels (IPsec/Gre/WireGuard) and validate after changes to avoid black holes.
