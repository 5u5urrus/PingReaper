# ICMP Filtering Check (`icmp_filtering_check`)

## Opening Scenario

During a perimeter assessment, a tester wants a quick picture of how a target handles ICMP. By probing a handful of common ICMP message types and noting which ones get any response, they build a fast **allow/deny profile**. The results immediately flag risky allowances like **Redirect** and **Timestamp**, and highlight inconsistent filtering across subnets.

## What This Test Is

This check sends representative ICMP message types to a target and records whether **any reply** is observed. The goal is to infer which ICMP classes appear **allowed** versus **filtered/blocked** at the host or along the path (firewall, router, IPS).

Types probed in this test:

* **0 — Echo Reply**
* **3 — Destination Unreachable**
* **5 — Redirect**
* **8 — Echo Request**
* **11 — Time Exceeded**
* **13 — Timestamp Request**
* **17 — Address Mask Request**

> Note: Some types (e.g., 0, 3, 5, 11) are typically *generated as responses* by intermediaries or hosts under certain conditions. Lack of a reply may reflect correct behavior, silent drop, or filtering. The objective here is policy reconnaissance, not strict RFC conformance testing.

## Why This Matters

* **Policy exposure:** Reveals which ICMP classes traverse the perimeter (good or bad).
* **Attack surface:** Dangerous allowances (e.g., **Redirect**, **Timestamp**, **Address Mask**) enable redirection, time disclosure, and subnet mapping.
* **Noise reduction:** Knowing what’s filtered helps attackers and defenders plan next steps (e.g., avoid ICMP-dependent tooling).

## How It Works

1. Send one probe for each selected ICMP type to the target.
2. If **any response** is observed, mark that type as **allowed**; otherwise, mark it **filtered** (or silently dropped).
3. Summarize into an **ICMP filtering profile** that informs risk and next actions.

## Realistic Scenarios

* **Firewall Misconfiguration Discovery** – A public-facing subnet allows **ICMP Redirect (Type 5)** to reach endpoints. The red team flags this as high risk: if accepted by hosts, it could enable stealth MITM redirection on internal segments.
* **Information Leakage via Timestamp** – Timestamp Requests (Type 13) receive Replies (Type 14) from several internal servers, exposing precise system time. The team pairs this with OTP timing attacks and device fingerprinting based on clock skew.
* **Segmentation Drift** – The DMZ drops **Time Exceeded (Type 11)** while the internal network allows it, enabling internal topology mapping via traceroute-style probing that isn’t possible from the internet.

## Defensive Recommendations

* **Deny by default** for ICMP types not operationally required.
* Common safe baseline for internet-facing hosts: allow only **Echo (8/0)** if needed, and selectively **Destination Unreachable (3)** for PMTUD; block **Redirect (5)**, **Timestamp (13/14)**, **Address Mask (17/18)**.
* Apply **consistent policies across zones** to prevent internal reconnaissance gaps.
* Prefer **stateless, normalized ICMP handling** at borders; log exceptions for review.
