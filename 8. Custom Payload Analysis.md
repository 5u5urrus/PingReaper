# Custom Payload Analysis (`custom_payload_analysis`)

## Opening Scenario

During an internal assessment, a tester sends ICMP Echo Requests with unusual payloads — long padding, binary blobs, and strings that look like code. Several hosts echo the data back exactly, but a few devices **strip `<script>` tags** and **truncate binary payloads**. That behavior exposes where traffic is being inspected or normalized, revealing security devices and custom stacks the team didn’t know were in the path.

## What This Test Is

This check sends Echo Requests with **non-standard payloads** (HTML/script snippets, path traversal strings, binary data, format strings, oversized padding) and observes whether the Echo Replies:

* Return the **exact payload** (typical, RFC-aligned behavior), or
* **Modify**, **drop**, or **truncate** the payload, or
* Respond with a **non-echo ICMP type** (unexpected).

Any deviation hints at middleboxes, deep inspection, or nonstandard ICMP implementations.

## Why This Matters

* **Maps security controls**: Payload normalization/stripping often indicates WAF/IPS/NGFW activity, even on ICMP.
* **Identifies custom stacks**: Embedded/legacy devices that mishandle binary or large payloads stand out.
* **Signals exfiltration feasibility**: Exact echo of arbitrary binary suggests ICMP could be used as a covert channel.
* **Finds stability bugs**: Truncation or non-echo responses can point to parsing quirks or fragile firmware.

## How It Works

1. Send Echo Requests carrying varied payloads: large padding, script-like text, traversal patterns, binary sequences, and format strings.
2. Compare each Echo Reply’s payload to what was sent.
3. Flag cases where the payload is **altered**, **dropped**, **truncated**, or the reply is a **different ICMP type**.
4. Summarize anomalies to highlight likely inspection points or noncompliant behavior.

## Realistic Scenarios

* **Security Device Discovery** – ICMP payloads containing `<script>` are echoed unchanged by most hosts, but replies from one network segment arrive with the tag stripped. The team infers an inline device performing content normalization on all traffic, not just HTTP, and maps its placement in the path.
* **Embedded Device Quirk** – An IoT controller echoes back only the first 64 bytes of any ICMP payload and sometimes replaces high-bit binary values. This fingerprint points to a specific vendor stack with known parsing issues, guiding targeted testing and patch recommendations.

## Defensive Recommendations

* **Normalize or limit ICMP** at network edges (consistent payload behavior, size caps).
* **Rate limit** ICMP to reduce abuse and reconnaissance signal.
* **Disable deep content inspection on ICMP** unless required; if enabled, document and monitor it.
* **Block external ICMP** where operationally feasible; allow only minimal, necessary types internally.
