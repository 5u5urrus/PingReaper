# ICMP OS Fingerprinting (`icmp_os_fingerprint`)

## Opening Scenario

During a quiet recon phase, a tester sends only a handful of ICMP packets. The replies come back with a **TTL of 128**, the payload is echoed **exactly**, and malformed ICMP is handled in a way consistent with modern Windows systems. Without touching a single TCP port, the tester already has a strong OS guess and can plan targeted next steps.

## What This Test Is

ICMP OS fingerprinting infers a target’s operating system by observing subtle differences in ICMP behavior. It looks at:

* **Default TTL values** in Echo Replies.
* **Payload handling** (exact echo vs. modified/dropped).
* **Error-handling behavior** when presented with malformed ICMP.

It’s lower profile than banner grabbing or full TCP scans and often works even when most services are blocked.

## Why This Matters

* Narrows exploit choices to the most likely OS family and version range.
* Reduces noisy scanning, helping avoid IDS/IPS alerts.
* Identifies network appliances/firmware where TCP services are hidden or filtered.

## How It Works

1. **Echo TTL Check** – Send an ICMP Echo Request and record the reply’s TTL.

   * Rough guide: ≈64 often Linux/Unix/macOS; ≈128 often Windows; ≈255 often network gear/embedded.
2. **Payload Handling** – Send an Echo with a known payload and compare the reply.

   * **Exact echo** is common; **modified or dropped payloads** can indicate specific stacks or middleboxes.
3. **Malformed ICMP Behavior** – Send an Echo with an invalid code and observe the response.

   * RFC-compliant stacks may return a specific ICMP error or silently drop; patterns can be distinctive.
4. **Synthesize Clues** – Combine TTL, payload behavior, and error responses into an OS family **guess** (probabilistic, not absolute).

## Realistic Scenarios

* **Stealth Recon in a DMZ** – Only ICMP is permitted inbound. Fingerprinting suggests a modern Windows Server host, so the team prioritizes Windows-specific vulnerabilities and avoids loud TCP sweeps.
* **Appliance Identification** – A target replies with TTL ≈255 and truncates payloads. Combined with consistent error behavior, this points to a network appliance/embedded OS, guiding the team toward SNMP/HTTP management paths and vendor-specific CVEs.

## Defensive Recommendations

* **Normalize** ICMP at gateways (fixed TTL, consistent payload behavior).
* **Rate-limit** ICMP and restrict it from untrusted networks.
* Prefer **uniform, minimal ICMP responses** or block externally where feasible.
* **Monitor** for unusual ICMP patterns that indicate reconnaissance.
