## ICMP Unreachable Analysis (`icmp_unreachable_analysis`)

### Opening Scenario

During a red team engagement against a corporate network, the attackers notice subtle differences in the ICMP “Destination Unreachable” messages returned by various systems. By analyzing these differences, they are able to infer which services are filtered, which ports are closed, and even which firewall rules are in place — all without sending traditional port scans that could trigger alerts.

---

### What This Test Is

ICMP “Destination Unreachable” messages (Type 3) are sent by a device when it cannot deliver an IP packet to its intended destination.
Type 3 has multiple **codes** indicating the specific reason for failure, such as:

* **Code 1** – Host Unreachable
* **Code 2** – Protocol Unreachable
* **Code 3** – Port Unreachable
* **Code 13** – Communication Administratively Prohibited

Different network devices and operating systems produce distinct behaviors and timing patterns for these responses.

---

### Why This Matters

* ICMP itself does not use ports — it operates below TCP and UDP in the network stack.
* However, ICMP *Destination Unreachable* responses can indirectly reveal information about port status when they are triggered by TCP or UDP probes.
* If a host or firewall returns distinct Type 3 codes for different situations (e.g., “Port Unreachable” vs. “Admin Prohibited”), an attacker can use these responses to **infer open/closed/filtered ports** without completing a full TCP handshake.
* This technique can also help map firewall rules, identify filtered services, and fingerprint network stacks — information that can be used to plan further attacks.

---

### How It Works

1. The attacker sends packets designed to trigger different unreachable conditions — such as to a non-existent host, using a bogus protocol, or targeting a high-numbered closed port.
2. If the target or an intermediate firewall responds with an ICMP Type 3 message, the code inside reveals *why* the packet could not be delivered.
3. By collecting and comparing these codes, the attacker can profile network behavior and filtering rules.

---

### Realistic Scenarios

* **Firewall Rule Mapping** – By sending packets to multiple ports and recording which return “Admin Prohibited” vs. “Port Unreachable,” an attacker can deduce the firewall’s filtering policy.
* **Service Inference** – An attacker sends TCP packets to closed ports and notes which return ICMP responses vs. which remain silent, inferring which ports might be open or filtered.
* **Network Stack Fingerprinting** – Variations in response codes, TTL values, and timing can identify the target’s OS or firewall vendor.

---

### Defensive Recommendations

* Configure firewalls and routers to use consistent, generic ICMP responses (or none at all) to avoid leaking filtering rules.
* Disable unnecessary ICMP Type 3 responses on public-facing systems.
* Use intrusion detection systems (IDS) to flag patterns of crafted packets designed to elicit different ICMP unreachable codes.
* Avoid relying solely on ICMP for blocking — combine with stateful firewall rules for better security.

